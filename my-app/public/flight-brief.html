<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Brief - PilotSeal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet" />
<link rel="stylesheet" href="Brief.css">
<!--<style>

</style>
-->
</head>
<body class="flightbrief-body">
  <div class="flight-section">
    <h1 class="text-3xl font-bold text-center mb-6">✈️ Flight Brief</h1>
    <hr class="dived-line"/>
    <h2 class="text-xl font-bold mb-4">📓Information</h2>
    <form class="space-y-4">
      <div class="inline-label-input">
        <label class="label" for="studentName">Student Name(Pilot Flying):</label>
        <input type="text" id="studentName" class="input-field" required />
      </div>
      <div class="inline-label-input">
        <label class="label" for="instructorName">Instructor Name(Pilot In Command):</label>
        <input type="text" id="instructorName" class="input-field" required />
      </div>
      <div class="inline-label-input">
        <label class="label" for="flight-rules">Flight Rules:</label>
        <select id="flight-rules" class="input-field" title="Select flight rules">
          <option value="VFR">VFR</option>
          <option value="IFR">IFR</option>
        </select>
      </div>
      <div class="inline-label-input">
        <label class="label" for="flightDate">Select Date</label>
        <input type="date" id="flightDate" class="input-field" required placeholder="Select date" title="Select date" lang="en" />
      </div>
      <div class="inline-label-input">
        <label class="label" for="etd">Estimated Time of Departure (ETD)</label>
        <input type="time" id="etd" class="input-field" required placeholder="Select time" title="Select time" />
      </div>
      <div class="inline-label-input">
        <label class="label" for="eta">Estimated Time of Arrival (ETA)</label>
        <input type="time" id="eta" class="input-field" required placeholder="Select time" title="Select time" />
      </div>
      <div class="inline-label-input">
        <label class="label" for="ete">Estimated Time Enroute (ETE)</label>
        <input type="text" id="ete" class="input-field" readonly placeholder="Auto-calculated" title="Calculated ETE" />
      </div>
      <div class="inline-label-input">
        <label class="label" for="aircraftId">Aircraft Tail Number:</label>
        <input type="text" id="aircraftId" class="input-field" required />
      </div>
      <div class="inline-label-input">
        <label class="label" for="fuel">Fuel Onboard (Gallons):</label>
        <input type="number" id="fuel" class="input-field" required />
      </div>
      <div class="inline-label-input">
        <label class="label" for="fuelTime">Fuel Time (hrs):</label>
        <input type="number" id="fuelTime" class="input-field" placeholder="e.g. 2.5" />
      </div>
      <hr class="dived-line"/>
      <h2 class="text-xl font-bold mb-4">🛫 Route</h2>
      <div class="inline-label-input">
        <label class="label" for="departure">Departure Point:</label>
        <input type="text" id="departure" class="input-field" required />
      </div>
      <div class="flex items-center gap-4 mt-4">
        <button type="button" id="btnCross" class="btn-toggle">Cross Country</button>
        <button type="button" id="btnLocal" class="btn-toggle">Local Practice</button>
      </div>
      <div id="crossCountryFields" class="space-y-3 mt-4 hidden" hidden>
        <label class="label">Intermediate Stop</label>
        <div class="flex items-center gap-2">
          <input type="text" name="stop[]" class="stop-input input-field" />
          <button type="button" class="remove-stop text-red-500 font-bold">✕</button>
        </div>
        <button type="button" id="addStop" class="text-blue-600 underline text-sm">+ Add Another Stop</button>
      </div>
      <div class="inline-label-input mt-4">
        <label class="label" for="arrival">Arrival Point:</label>
        <input type="text" id="arrival" class="input-field" required />
      </div>
      <!-- Lesson Practice section inserted here -->
      <div class="section inline-label-input">
        <label class="label" for="lessonPractice"><strong>✏️ Lesson Practice:</strong></label>
        <input type="text" id="lessonPractice" class="input-field" placeholder="e.g., Steep Turns, Slow Flight, Short Field Landing">
      </div>
    </form>
    <hr class="dived-line"/>
    <h2 class="text-xl font-bold mb-4">🌦️ Weather Information</h2>
    <div id="weather-section" class="space-y-6">
      <div class="text-center">
        <button id="fetchWeatherBtn" type="button" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
          Fetch Weather
        </button>
      </div>
      <div>
        <h3>🟢 METAR</h3>
        <div id="metar-section" class="space-y-2"></div>
      </div>
      <div>
        <h3>🟡 TAF</h3>
        <div id="taf-section" class="space-y-2"></div>
      </div>
      <div>
        <h3>🔴 AIRMET/SIGMET</h3>
        <div id="airsigmet-section" class="space-y-2"></div>
      </div>
      <div>
        <h3 class="section-subtitle">📏 Density Altitude (DA)</h3>
        <div class="inline-label-input">
          <label class="label" for="fieldElevation">Field Elevation (ft)</label>
          <input type="number" id="fieldElevation" class="input-field" placeholder="e.g. 2500" />
        </div>
        <div class="inline-label-input">
          <label class="label" for="outsideTemp">Outside Air Temperature (°C)</label>
          <input type="number" id="outsideTemp" class="input-field" placeholder="e.g. 30" />
        </div>
        <button type="button" id="calculateDA" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mb-2">
          Calculate DA
        </button>
        <div id="daResult" class="text-sm text-gray-700 font-medium mt-2"></div>
      </div>
    </div>
    <!-- Notes / NOTAMs section inserted after weather information, before Weight & Balance -->
    <div class="section inline-label-input">
      <label class="label" for="weatherNotes"><strong>📝 Notes / NOTAMs</strong></label>
      <textarea id="weatherNotes" rows="3" class="input-field" placeholder="Enter NOTAMs, ATIS, or other relevant notes here..."></textarea>
    </div>
   <hr class="dived-line"/>
    <h2 class="text-xl font-bold mb-4">⚖️ Aircraft Conditions</h2>
    <div class="space-y-4">
      <div class="inline-label-input">
        <label class="label" for="grossWeight">Total Gross Weight (lbs):</label>
        <input type="number" id="grossWeight" class="input-field" placeholder="e.g. 2400" />
      </div>
      <div class="inline-label-input">
        <label class="label" for="withinLimitsText">Enter "within limits" to confirm:</label>
        <input type="text" id="withinLimitsText" class="input-field" placeholder="within limits" oninput="checkWithinLimits()" />
        <span id="withinLimitsStatus" class="text-sm ml-2"></span>
      </div>
      <div class="inline-label-input">
        <label class="label" for="mx-now">Mx Time Now:</label>
        <input type="number" id="mx-now" class="input-field" placeholder="Check Aircraft" />
      </div>
      <div class="inline-label-input">
        <label class="label" for="mx-due">Next Mx Due:</label>
        <input type="number" id="mx-due" class="input-field" placeholder="Next 100 hr/annual eg." />
      </div>
      
    </div>
    <hr class="dived-line"/>
    <h2>🧭 Risk Assessment</h2>
    <div class="risk-columns">
      <div class="static-risk-column">
        <h3>🪨 Static Risk</h3>
        <div class="risk-item">
          <label for="static-dual-flight">Dual flight:</label>
          <input type="checkbox" class="static-risk" value="1" id="static-dual-flight" name="static-dual-flight">
        </div>
        <div class="risk-item">
          <label for="static-training-pre-solo">Training Pre-solo student:</label>
          <input type="checkbox" class="static-risk" value="3" id="static-training-pre-solo" name="static-training-pre-solo">
        </div>
        <div class="risk-item">
          <label for="static-solo-student">SOLO student:</label>
          <input type="checkbox" class="static-risk" value="3" id="static-solo-student" name="static-solo-student">
        </div>
        <div class="risk-item">
          <label for="static-dpe-check">DPE or Check flight:</label>
          <input type="checkbox" class="static-risk" value="2" id="static-dpe-check" name="static-dpe-check">
        </div>
        <div class="risk-item">
          <label for="imsafe-risk">IMSAFE (each factor counts 1):</label>
          <input type="number" id="imsafe-risk" name="imsafe-risk" min="0" max="6" value="0">
        </div>
        <div class="risk-item">
          <label for="static-first-fly-fi">First fly with FI:</label>
          <input type="checkbox" class="static-risk" value="1" id="static-first-fly-fi" name="static-first-fly-fi">
        </div>
        <div class="risk-item">
          <label for="static-different-model">Different model:</label>
          <input type="checkbox" class="static-risk" value="1" id="static-different-model" name="static-different-model">
        </div>
        <div class="risk-item">
          <label for="static-last-flight-30">Last flight &gt;30 days:</label>
          <input type="checkbox" class="static-risk" value="1" id="static-last-flight-30" name="static-last-flight-30">
        </div>
        <div class="risk-item">
          <label for="static-acft-time-40">Aircraft time &lt; 40 hours (Rated):</label>
          <input type="checkbox" class="static-risk" value="1" id="static-acft-time-40" name="static-acft-time-40">
        </div>
        <div class="risk-item">
          <label for="static-fi-dual-200">FI &lt; 200 hours Dual given:</label>
          <input type="checkbox" class="static-risk" value="1" id="static-fi-dual-200" name="static-fi-dual-200">
        </div>
      </div>
      <div class="dynamic-risk-column">
        <h3>🌪️ Dynamic Risk</h3>
        <div class="risk-item">
          <label for="dynamic-night-ops">Night ops:</label>
          <input type="checkbox" class="dynamic-risk" value="1" id="dynamic-night-ops" name="dynamic-night-ops">
        </div>
        <div class="risk-item">
          <label for="dynamic-last-night-30">Last night &gt;30 days:</label>
          <input type="checkbox" class="dynamic-risk" value="1" id="dynamic-last-night-30" name="dynamic-last-night-30">
        </div>
        <div class="risk-item">
          <label for="dynamic-svfr">SVFR:</label>
          <input type="checkbox" class="dynamic-risk" value="1" id="dynamic-svfr" name="dynamic-svfr">
        </div>
        
        <div class="risk-item">
          <label for="dynamic-gust-spread">Gust spread &gt; 13 kt:</label>
          <input type="checkbox" class="dynamic-risk" value="1" id="dynamic-gust-spread" name="dynamic-gust-spread">
        </div>
        <div class="risk-item">
          <label for="dynamic-other-fi-cancel">Other FI cancellation due to WX:</label>
          <input type="checkbox" class="dynamic-risk" value="1" id="dynamic-other-fi-cancel" name="dynamic-other-fi-cancel">
        </div>
        <div class="risk-item">
          <label for="dynamic-max-fuel-flight">Max fuel flight:</label>
          <input type="checkbox" class="dynamic-risk" value="1" id="dynamic-max-fuel-flight" name="dynamic-max-fuel-flight">
        </div>
        <!-- 新增 Full down auto 选项 -->
        <div class="risk-item">
          <label for="full-down-auto">Full down auto:</label>
          <input type="checkbox" class="dynamic-risk" value="1" id="full-down-auto" name="full-down-auto">
        </div>
        <div class="risk-item">
          <label for="dynamic-stall-training">STALL Training:</label>
          <input type="checkbox" class="dynamic-risk" value="1" id="dynamic-stall-training" name="dynamic-stall-training">
        </div>
        <div class="risk-item">
          <label for="dynamic-spin-training">SPIN Training:</label>
          <input type="checkbox" class="dynamic-risk" value="2" id="dynamic-spin-training" name="dynamic-spin-training">
        </div>
        <div class="risk-item">
          <label for="other-risk">Other Risks:</label>
          <input type="number" class="dynamic-risk" name="other-risk" min="0" max="5" value="0">
        </div>
      </div>
    </div>
            <!-- Risk Discussion / Comments section at page bottom -->
    <div class="section inline-label-input">
      <label class="label" for="riskComments"><strong>🗒️ Risk Discussion / Comments</strong></label>
      <textarea id="riskComments" rows="3" class="input-field" placeholder="Notes from discussion with senior/chief pilot..."></textarea>
    </div>
    <div id="totalRiskScore" style="font-weight:bold; margin-top:10px;">
      Total Risk Score: <span id="riskScoreValue">0</span>
      <span id="riskScoreLevel" style="margin-left:15px; font-weight:bold;"></span>
      <div id="riskRecommendation" style="margin-top:5px; font-style:italic;"></div>
    </div>
    <div style="text-align: center; margin-top: 2rem;">
      <button id="generateReportBtn">Generate Flight Brief Report</button>
    </div>
  </div>

<script>
  let latestAltimeter = null;
  let latestTemperatureC = null;

  const btnCross = document.getElementById('btnCross');
  const btnLocal = document.getElementById('btnLocal');
  const crossCountryFields = document.getElementById('crossCountryFields');
  const departure = document.getElementById('departure');
  const arrival = document.getElementById('arrival');
  const addStopBtn = document.getElementById('addStop');

  btnCross.addEventListener('click', () => {
    crossCountryFields.classList.remove('hidden');
    crossCountryFields.removeAttribute('hidden');
    btnCross.classList.add('active');
    btnLocal.classList.remove('active');
    arrival.value = '';
  });

  btnLocal.addEventListener('click', () => {
    crossCountryFields.classList.add('hidden');
    crossCountryFields.setAttribute('hidden', '');
    btnLocal.classList.add('active');
    btnCross.classList.remove('active');
    arrival.value = departure.value;
  });

  departure.addEventListener('input', () => {
    if (crossCountryFields.classList.contains('hidden')) {
      arrival.value = departure.value;
    }
  });

  addStopBtn.addEventListener('click', () => {
    const stopDiv = document.createElement('div');
    stopDiv.classList.add('flex', 'items-center', 'gap-2');
    stopDiv.innerHTML = `
      <input type="text" name="stop[]" class="stop-input w-full p-2 border border-gray-300 rounded" />
      <button type="button" class="remove-stop text-red-500 font-bold">✕</button>
    `;
    crossCountryFields.insertBefore(stopDiv, addStopBtn);
  });

  // Event delegation for removing stops
  crossCountryFields.addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-stop')) {
      e.target.parentElement.remove();
    }
  });

  // --------- Weather Info Section ---------

  async function fetchData(url) {
    const response = await fetch(url);
    return await response.json();
  }

  async function displayWeather() {
    const airports = [];

    const dep = document.getElementById('departure')?.value.trim();
    if (dep) airports.push(dep.toUpperCase());

    const stops = Array.from(document.querySelectorAll('.stop-input')).map(i => i.value.trim()).filter(Boolean);
    airports.push(...stops.map(s => s.toUpperCase()));

    const arr = document.getElementById('arrival')?.value.trim();
    if (arr) airports.push(arr.toUpperCase());

    const metarSection = document.getElementById('metar-section');
    const tafSection = document.getElementById('taf-section');
    const airsigmetSection = document.getElementById('airsigmet-section');

    metarSection.innerHTML = '';
    tafSection.innerHTML = '';
    airsigmetSection.innerHTML = '';

    for (const icao of airports) {
      const metarUrl = `https://brief.r1978244759.workers.dev/?url=https://avwx.rest/api/metar/${icao}?format=json`;
      const tafUrl = `https://brief.r1978244759.workers.dev/?url=https://avwx.rest/api/taf/${icao}?format=json`;
      const metarData = await fetchData(metarUrl);
      const tafData = await fetchData(tafUrl);

      // Extract altimeter and temperature if not already set
      if (!latestAltimeter && metarData?.altimeter?.value) {
        latestAltimeter = metarData.altimeter.value;
      }
      if (!latestTemperatureC && metarData?.temperature?.value) {
        latestTemperatureC = metarData.temperature.value;
        document.getElementById('outsideTemp').value = latestTemperatureC; // 自动填入输入框
      }

      const metarDiv = document.createElement('div');
      metarDiv.className = 'bg-gray-100 p-3 rounded border';
      metarDiv.textContent = `METAR for ${icao}: ${metarData?.raw || 'Unavailable'}`;
      metarSection.appendChild(metarDiv);

      const tafDiv = document.createElement('div');
      tafDiv.className = 'bg-gray-100 p-3 rounded border';
      tafDiv.textContent = `TAF for ${icao}: ${tafData?.raw || 'Unavailable'}`;
      tafSection.appendChild(tafDiv);
    }

    // AIRMET/SIGMET（仅显示一次）
    const sigmetUrl = `https://brief.r1978244759.workers.dev/?url=https://avwx.rest/api/airsigmet?format=json`;
    const airsigmetData = await fetchData(sigmetUrl);
    const airsigDiv = document.createElement('div');
    airsigDiv.className = 'bg-gray-100 p-3 rounded border';
    airsigDiv.textContent = Array.isArray(airsigmetData) && airsigmetData.length
      ? `${airsigmetData.length} active AIRMET/SIGMETs in U.S. FIRs`
      : 'No active AIRMET/SIGMETs';
    airsigmetSection.appendChild(airsigDiv);
  }

  // 在 Fetch Weather 按钮点击时附加天气展示逻辑
  document.getElementById('fetchWeatherBtn').addEventListener('click', async () => {
    await displayWeather();
  });

document.getElementById('calculateDA').addEventListener('click', () => {
  const elevation = parseFloat(document.getElementById('fieldElevation').value);
  const temperature = parseFloat(document.getElementById('outsideTemp').value);
  const resultDiv = document.getElementById('daResult');

  if (isNaN(elevation)) {
    resultDiv.textContent = 'Please enter field elevation.';
    return;
  }

  if (!latestAltimeter || isNaN(temperature)) {
    resultDiv.textContent = 'Weather data is missing or invalid. Please click "Fetch Weather" first.';
    return;
  }

  const pressureAltitude = (29.92 - latestAltimeter) * 1000 + elevation;
  const isaTemp = 15 - (2 * (elevation / 1000));
  const da = Math.round(pressureAltitude + (120 * (temperature - isaTemp)));

  resultDiv.textContent = `Estimated Density Altitude: ${da.toLocaleString()} ft (using Altimeter ${latestAltimeter} inHg)`;
});
//计算剩余时间
const mxNow = parseFloat(document.getElementById("mx-now")?.value || 0);
const mxDue = parseFloat(document.getElementById("mx-due")?.value || 0);
const mxRemaining = (mxDue - mxNow).toFixed(1); // 保留一位小数

// --- Risk Assessment Calculation (new version) ---
function updateRiskScore() {
let staticScore = 0;
let dynamicScore = 0;

// 处理 static-risk，只处理勾选的 checkbox
document.querySelectorAll('.static-risk:checked').forEach(cb => {
  staticScore += parseInt(cb.value);
});

// 处理 dynamic-risk：checkbox + number
document.querySelectorAll('.dynamic-risk').forEach(input => {
  if (input.type === 'checkbox' && input.checked) {
    dynamicScore += parseInt(input.value);
  } else if (input.type === 'number') {
    dynamicScore += parseInt(input.value) || 0;
  }
});

// 特别处理 IMSAFE 数字输入（归类在 static-risk）
let imsafeValue = parseInt(document.getElementById('imsafe-risk').value) || 0;
staticScore += imsafeValue;

let total = staticScore + dynamicScore;

  const riskScoreValue = document.getElementById('riskScoreValue');
  const riskScoreLevel = document.getElementById('riskScoreLevel');
  const riskRecommendation = document.getElementById('riskRecommendation');

  riskScoreValue.textContent = total;

  if (total <= 10) {
    riskScoreLevel.textContent = '🟢 LOW RISK';
    riskScoreLevel.style.color = 'green';
    riskRecommendation.textContent = 'Risk acceptable after discussion. Flight may proceed.';
  } else if (total > 10 && total <= 15) {
    riskScoreLevel.textContent = '🟡 MODERATE RISK';
    riskScoreLevel.style.color = 'orange';
    riskRecommendation.textContent = 'Consult with senior or chief instructor to discuss risk mitigation. May proceed after reduction.';
  } else {
    riskScoreLevel.textContent = '🔴 HIGH RISK';
    riskScoreLevel.style.color = 'red';
    riskRecommendation.textContent = 'Flight requires Chief Pilot approval. Discuss flight plan in detail.';
  }
}

document.querySelectorAll('.static-risk, .dynamic-risk').forEach(cb => {
  cb.addEventListener('change', updateRiskScore);
});
document.getElementById('imsafe-risk').addEventListener('input', updateRiskScore);
// --- Within Limits Confirmation ---
function checkWithinLimits() {
  const val = document.getElementById('withinLimitsText').value.trim().toLowerCase();
  const status = document.getElementById('withinLimitsStatus');
  if (val === "within limits") {
    status.textContent = "✅ Confirmed";
    status.className = "text-green-600 text-sm ml-2";
  } else {
    status.textContent = "❌ Not Confirmed";
    status.className = "text-red-600 text-sm ml-2";
  }
}
</script>
<script>
// ETE Calculation Logic
function calculateETE() {
  const etd = document.getElementById('etd').value;
  const eta = document.getElementById('eta').value;
  const eteField = document.getElementById('ete');

  if (etd && eta) {
    const [etdH, etdM] = etd.split(':').map(Number);
    const [etaH, etaM] = eta.split(':').map(Number);

    let etdMinutes = etdH * 60 + etdM;
    let etaMinutes = etaH * 60 + etaM;

    // Handle next-day arrival
    if (etaMinutes < etdMinutes) {
      etaMinutes += 24 * 60;
    }

    const eteMinutes = etaMinutes - etdMinutes;
    const eteHoursDecimal = (eteMinutes / 60).toFixed(2);

    eteField.value = eteHoursDecimal;
  } else {
    eteField.value = '';
  }
}

document.getElementById('etd').addEventListener('change', calculateETE);
document.getElementById('eta').addEventListener('change', calculateETE);
</script>
<script>
// Generate Flight Brief Report Button Logic
document.getElementById("generateReportBtn").addEventListener("click", function () {
  // Check for within limits confirmation
  const withinLimitsInput = document.getElementById('withinLimitsText').value.trim().toLowerCase();
  if (withinLimitsInput !== "within limits") {
    alert("Please enter 'within limits' to confirm weight & CG limits.");
    return;
  }
  // Gather required info
  const pilotName = document.getElementById("studentName")?.value || '';
  const instructorName = document.getElementById("instructorName")?.value || '';
  const date = document.getElementById("flightDate")?.value || '';
  const tailNumber = document.getElementById("aircraftId")?.value || '';
  const fuelOnBoard = document.getElementById("fuel")?.value || '';
  const dep = document.getElementById("departure")?.value || '';
  const arr = document.getElementById("arrival")?.value || '';
  const eta = document.getElementById("eta")?.value || '';
  const etd = document.getElementById("etd")?.value || '';
  const lessonPractice = document.getElementById("lessonPractice")?.value || '';
  const da = document.getElementById("daResult")?.textContent || '';
  const wnbGross = document.getElementById("grossWeight")?.value || '';
  const wnbFuelTime = document.getElementById("fuelTime")?.value || '';
  const weatherNotes = document.getElementById("weatherNotes")?.value || '';
  const riskComments = document.getElementById("riskComments")?.value || '';

  // 1. Flight Rules
  const flightRulesSel = document.getElementById('flight-rules');
  const flightRules = flightRulesSel ? flightRulesSel.options[flightRulesSel.selectedIndex].value : '';

  // 2. ETD, ETA, ETE
  // ETE: recalculate here to be sure
  let eteStr = '';
  if (etd && eta) {
    const [etdH, etdM] = etd.split(':').map(Number);
    const [etaH, etaM] = eta.split(':').map(Number);
    let etdMinutes = etdH * 60 + etdM;
    let etaMinutes = etaH * 60 + etaM;
    if (etaMinutes < etdMinutes) etaMinutes += 24 * 60;
    const eteMinutes = etaMinutes - etdMinutes;
    const eteHoursDecimal = (eteMinutes / 60).toFixed(2);
    eteStr = eteHoursDecimal;
  }

  // 3. Static Risk & Dynamic Risk
  // Static Risk: checkboxes
  const staticRiskCheckboxes = Array.from(document.querySelectorAll('.static-risk[type="checkbox"]'));
  let staticRiskItems = [];
  let staticRiskScore = 0;
  staticRiskCheckboxes.forEach(cb => {
    if (cb.checked) {
      const label = cb.parentElement.querySelector('label');
      staticRiskItems.push(`- ${label ? label.textContent.replace(/:$/, '') : cb.name} [${cb.value}]`);
      staticRiskScore += parseInt(cb.value);
    }
  });
  // IMSAFE
  const imsafeValue = parseInt(document.getElementById('imsafe-risk').value) || 0;
  staticRiskScore += imsafeValue;

  // Dynamic Risk: checkboxes and number
  const dynamicRiskCheckboxes = Array.from(document.querySelectorAll('.dynamic-risk[type="checkbox"]'));
  let dynamicRiskItems = [];
  let dynamicRiskScore = 0;
  dynamicRiskCheckboxes.forEach(cb => {
    if (cb.checked) {
      const label = cb.parentElement.querySelector('label');
      dynamicRiskItems.push(`- ${label ? label.textContent.replace(/:$/, '') : cb.name} [${cb.value}]`);
      dynamicRiskScore += parseInt(cb.value);
    }
  });
  // "Other Risks" (number input in dynamic-risk)
  let otherRisksValue = 0;
  document.querySelectorAll('.dynamic-risk[type="number"]').forEach(input => {
    const val = parseInt(input.value) || 0;
    if (val > 0) {
      const label = input.parentElement.querySelector('label');
      dynamicRiskItems.push(`- ${label ? label.textContent.replace(/:$/, '') : input.name} [${val}]`);
      otherRisksValue += val;
      dynamicRiskScore += val;
    }
  });

  // 4. IMSAFE & Other Risks (already included above)
  // riskScore, riskCategory, riskAdvice
  const riskScore = staticRiskScore + dynamicRiskScore;
  let riskCategory = '';
  let riskAdvice = '';
  if (riskScore <= 10) {
    riskCategory = '🟢 LOW RISK';
    riskAdvice = 'Risk acceptable after discussion. Flight may proceed.';
  } else if (riskScore > 10 && riskScore <= 15) {
    riskCategory = '🟡 MODERATE RISK';
    riskAdvice = 'Consult with senior or chief instructor to discuss risk mitigation. May proceed after reduction.';
  } else {
    riskCategory = '🔴 HIGH RISK';
    riskAdvice = 'Flight requires Chief Pilot approval. Discuss flight plan in detail.';
  }

  // Compose printable report
  let reportText = `=== PilotSeal Flight Brief Report ===

PF: ${pilotName}
PIC: ${instructorName}
Date: ${date}
Aircraft: ${tailNumber}
Fuel: ${fuelOnBoard}

Flight Rules: ${flightRules}

ETD: ${etd}
ETA: ${eta}
ETE: ${eteStr ? eteStr + ' hours' : ''}

Departure: ${dep}
Arrival: ${arr}
Lesson Practice: ${lessonPractice}

📝 Notes / NOTAMs:
${weatherNotes}

Density Altitude: ${da}
Gross Weight: ${wnbGross}
Fuel Time: ${wnbFuelTime}
Mx Remaining:${mxRemaining}

🪨 Static Risk:
${staticRiskItems.length ? staticRiskItems.join('\n') : '- None'}
Total Static Risk Score: ${staticRiskScore}

🌪️ Dynamic Risk:
${dynamicRiskItems.length ? dynamicRiskItems.join('\n') : '- None'}
Total Dynamic Risk Score: ${dynamicRiskScore}

IMSAFE: ${imsafeValue}
Other Risks: ${otherRisksValue}

Total Risk Score: ${riskScore}
Category: ${riskCategory}
Advice: ${riskAdvice}

🗒️ Risk Discussion / Comments:
${riskComments}
`;

  // Use a print area if exists, otherwise open new window
  let printArea = document.querySelector('.print-area');
  if (!printArea) {
    // fallback: open new window for print
    const reportWindow = window.open("", "_blank");
    reportWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>PilotSeal Flight Brief Report</title>
        <style>
          body { font-family: 'Consolas', 'Menlo', 'Monaco', monospace; white-space: pre-wrap; margin: 2em; }
          h1 { font-size: 1.6em; font-weight: bold; margin-bottom: 1em; }
        </style>
      </head>
      <body>
        <pre>${reportText.replace(/</g, '&lt;')}</pre>
        
      </body>
      </html>
    `);
    reportWindow.document.close();
  } else {
    printArea.innerText = reportText;
    //window.print();
  }
});
</script>
</body>
</html>
</div>